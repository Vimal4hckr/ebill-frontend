<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create New Bill</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    input {
      flex: 1;
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #333;
      color: #fff;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      align-items: center;
    }
    button {
      padding: 10px 15px;
      cursor: pointer;
    }
    .total {
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<script>
  // üîê AUTH GUARD
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "admin-login.html";
  }
</script>

<div class="container">
  <h2>Create New Bill</h2>

  <!-- CUSTOMER DETAILS -->
  <div class="row">
    <input id="customerName" placeholder="Customer Name" />
    <input id="customerPhone" placeholder="Phone Number (91XXXXXXXXXX)" />
  </div>

  <!-- ITEMS TABLE -->
  <table>
    <thead>
      <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>‚ùå</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <div class="actions">
    <button onclick="addItem()">‚ûï Add Item</button>
    <div class="total">Grand Total: ‚Çπ<span id="grandTotal">0</span></div>
  </div>

  <div class="actions">
    <button onclick="goBack()">‚¨Ö Back</button>
    <button onclick="createBill()">‚úÖ Create Bill</button>
  </div>
</div>

<script>
  const API_BASE = "https://ebill-backend.onrender.com";

  function addItem() {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input placeholder="Item name" /></td>
      <td><input type="number" value="1" min="1" oninput="calc()" /></td>
      <td><input type="number" value="0" min="0" oninput="calc()" /></td>
      <td class="rowTotal">0</td>
      <td><button onclick="removeRow(this)">X</button></td>
    `;
    document.getElementById("itemsBody").appendChild(row);
  }

  function removeRow(btn) {
    btn.parentElement.parentElement.remove();
    calc();
  }

  function calc() {
    let grand = 0;
    document.querySelectorAll("#itemsBody tr").forEach(row => {
      const qty = Number(row.children[1].children[0].value);
      const price = Number(row.children[2].children[0].value);
      const total = qty * price;
      row.querySelector(".rowTotal").innerText = total;
      grand += total;
    });
    document.getElementById("grandTotal").innerText = grand;
  }

  function createBill() {
    const items = [];

    document.querySelectorAll("#itemsBody tr").forEach(row => {
      items.push({
        name: row.children[0].children[0].value,
        qty: Number(row.children[1].children[0].value),
        price: Number(row.children[2].children[0].value),
        total: Number(row.querySelector(".rowTotal").innerText)
      });
    });

    const payload = {
      customerName: document.getElementById("customerName").value,
      customerPhone: document.getElementById("customerPhone").value,
      items,
      totalAmount: Number(document.getElementById("grandTotal").innerText)
    };

    fetch(`${API_BASE}/api/bill/create`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": token
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (res.status === 401) {
        localStorage.removeItem("token");
        window.location.href = "admin-login.html";
        return;
      }
      return res.json();
    })
    .then(data => {
      if (!data) return;
      alert("Bill created successfully!");
      window.location.href = "admin.html";
    })
    .catch(err => {
      console.error(err);
      alert("Error creating bill");
    });
  }

  function goBack() {
    window.location.href = "admin.html";
  }

  // add first row by default
  addItem();
</script>

</body>
</html>
